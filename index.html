<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/8/8a/Google_Gemini_logo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
    <title>Nova Ai</title>
    <meta name="description" content="A capable, multimodal AI assistant powered by Google Gemini 2.5, featuring real-time streaming, web search grounding, and image analysis." />
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="./manifest.json" />
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Google_Gemini_logo.svg/192px-Google_Gemini_logo.svg.png" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#0b0f19" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Nova Assistant" />
    <meta property="og:description" content="Experience the power of Gemini 2.5 with Nova. Real-time AI chat and code assistance." />
    <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/8/8a/Google_Gemini_logo.svg" />

    <script>
      // Polyfill process for browser environment if not present (prevents crash in raw HTML mode)
      if (typeof process === 'undefined') {
        window.process = { env: {} };
      }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' },
              primary: { 500: '#3b82f6', 600: '#2563eb' }
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'scale-in': 'scaleIn 0.2s ease-out',
            },
            keyframes: {
                fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                scaleIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
            }
          }
        }
      }
    </script>
    <style>
      html, body { background-color: #0b0f19; color: #f3f4f6; height: 100%; height: 100dvh; width: 100%; overflow: hidden; overscroll-behavior: none; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
      .typing-dot { width: 6px; height: 6px; background-color: #9ca3af; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
      .typing-dot:nth-child(1) { animation-delay: -0.32s; }
      .typing-dot:nth-child(2) { animation-delay: -0.16s; }
      @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
      .markdown-content code { background-color: #1f2937; padding: 0.1em 0.3em; border-radius: 0.2em; font-family: monospace; font-size: 0.9em; color: #93c5fd; }
      .markdown-content pre { background-color: #111827; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin: 0.5em 0; border: 1px solid #374151; }
      .markdown-content pre code { background-color: transparent; padding: 0; color: #e5e7eb; font-size: 0.85em; }
      .markdown-content strong { color: white; font-weight: bold; }
      .markdown-content a { color: #60a5fa; text-decoration: none; }
      .markdown-content a:hover { text-decoration: underline; }
      .markdown-content p { margin-bottom: 0.5em; line-height: 1.6; }
      .markdown-content h1 { font-size: 1.5em; font-weight: bold; margin-top: 0.8em; margin-bottom: 0.4em; color: white; }
      .markdown-content h2 { font-size: 1.25em; font-weight: bold; margin-top: 0.8em; margin-bottom: 0.4em; color: white; }
      .markdown-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.5em; }
      .markdown-content ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.5em; }
    </style>
    <!-- Import Map for Google GenAI SDK -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide": "https://unpkg.com/lucide@latest",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-950 text-gray-100 font-sans selection:bg-primary-500/30">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-[#0b0f19]">
        <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-primary-600/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-1/4 right-1/4 w-64 h-64 bg-purple-600/20 rounded-full blur-[100px]"></div>
        <div class="relative z-10 flex flex-col items-center animate-fade-in">
            <div class="w-24 h-24 bg-gradient-to-br from-primary-500 to-purple-600 rounded-3xl flex items-center justify-center shadow-2xl shadow-primary-500/40 mb-8 animate-bounce">
               <i data-lucide="sparkles" class="text-white w-12 h-12"></i>
            </div>
            <h1 class="text-5xl font-bold text-white tracking-tight mb-3">Nova AI</h1>
            <p class="text-gray-400 text-sm font-medium tracking-wide uppercase">Created by Lawson Morris</p>
            <div class="mt-10">
              <i data-lucide="loader-2" class="text-primary-500 animate-spin w-8 h-8"></i>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden min-h-[100dvh] w-full bg-gray-950 flex items-center justify-center p-4 relative overflow-hidden">
        <div class="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-primary-600/20 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-purple-600/20 rounded-full blur-[120px]"></div>
        <div class="relative z-10 max-w-md w-full bg-gray-900/80 backdrop-blur-xl border border-gray-800 p-8 rounded-3xl shadow-2xl">
            <div class="flex flex-col items-center text-center mb-8">
                <div class="w-14 h-14 bg-gradient-to-br from-primary-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-primary-500/30 mb-4">
                    <i data-lucide="sparkles" class="text-white w-7 h-7"></i>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Welcome to Nova</h1>
                <p id="login-subtitle" class="text-gray-400 text-sm mt-1">Sign in to continue</p>
                <div class="mt-3 flex items-start gap-2 text-left bg-blue-900/20 border border-blue-800/50 p-2.5 rounded-lg">
                   <i data-lucide="info" class="text-blue-400 w-4 h-4 mt-0.5 flex-shrink-0"></i>
                   <p class="text-[10px] text-blue-200/80 leading-tight"><strong>Note:</strong> Nova runs entirely in your browser. Accounts are stored locally on this device.</p>
                </div>
            </div>
            <form id="auth-form" class="space-y-4">
                <div id="name-field" class="hidden">
                    <label class="block text-xs font-medium text-gray-400 mb-1.5 ml-1">Full Name</label>
                    <div class="relative">
                        <i data-lucide="user" class="absolute left-3 top-3 text-gray-500 w-4 h-4"></i>
                        <input type="text" id="input-name" class="w-full bg-gray-950 border border-gray-800 text-white rounded-xl py-2.5 pl-10 pr-4 focus:outline-none focus:border-primary-500 transition-colors placeholder-gray-600" placeholder="John Doe">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1.5 ml-1">Email Address</label>
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-3 top-3 text-gray-500 w-4 h-4"></i>
                        <input type="email" id="input-email" required class="w-full bg-gray-950 border border-gray-800 text-white rounded-xl py-2.5 pl-10 pr-4 focus:outline-none focus:border-primary-500 transition-colors placeholder-gray-600" placeholder="you@example.com">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1.5 ml-1">Password</label>
                    <div class="relative">
                        <i data-lucide="shield-check" class="absolute left-3 top-3 text-gray-500 w-4 h-4"></i>
                        <input type="password" id="input-password" required class="w-full bg-gray-950 border border-gray-800 text-white rounded-xl py-2.5 pl-10 pr-4 focus:outline-none focus:border-primary-500 transition-colors placeholder-gray-600" placeholder="••••••••">
                    </div>
                </div>
                
                <!-- Fake Captcha -->
                <div id="captcha-container" class="flex items-center p-3 rounded-xl border border-gray-700 bg-gray-950 cursor-pointer transition-all select-none hover:border-gray-600">
                    <div id="captcha-box" class="w-6 h-6 rounded border border-gray-600 bg-gray-800 flex items-center justify-center mr-3 transition-colors">
                         <i data-lucide="check" class="text-white w-4 h-4 hidden"></i>
                    </div>
                    <span id="captcha-text" class="text-sm text-gray-400">I am not a robot</span>
                    <div class="ml-auto opacity-50 grayscale">
                        <img src="https://www.gstatic.com/recaptcha/api2/logo_48.png" alt="captcha" class="w-8">
                    </div>
                </div>
                
                <!-- Terms Checkbox -->
                <div id="terms-container" class="hidden flex items-start space-x-3 px-1">
                    <div id="terms-checkbox" class="w-5 h-5 mt-0.5 rounded border border-gray-600 bg-gray-950 flex items-center justify-center cursor-pointer flex-shrink-0 hover:border-gray-500 transition-colors">
                        <i data-lucide="check" class="text-white w-3 h-3 hidden"></i>
                    </div>
                    <p class="text-xs text-gray-400 leading-relaxed">
                        I agree to the <button type="button" id="open-terms-link" class="text-primary-400 hover:text-primary-300 underline">Terms and Conditions</button> and acknowledge that AI can make mistakes.
                    </p>
                </div>
                
                <div id="auth-error" class="hidden flex items-center text-red-400 text-xs bg-red-500/10 p-3 rounded-lg border border-red-500/20">
                    <i data-lucide="alert-circle" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                    <span id="auth-error-text"></span>
                </div>

                <button type="submit" id="auth-submit-btn" class="w-full bg-primary-600 hover:bg-primary-500 text-white font-medium py-3 px-4 rounded-xl transition-colors shadow-lg shadow-primary-600/20 mt-2 flex justify-center items-center">
                    <span>Sign In</span>
                </button>
            </form>
            <div class="text-center pt-2">
                <button id="toggle-auth-mode" class="text-xs text-gray-500 hover:text-primary-400 transition-colors">Don't have an account? Sign Up</button>
            </div>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="hidden flex h-[100dvh] bg-gray-950 text-gray-100 relative overflow-hidden">
        
        <!-- SIDEBAR -->
        <div id="sidebar" class="hidden lg:flex flex-col w-72 h-full border-r border-gray-800 bg-gray-950 p-4 z-40 absolute lg:relative transform transition-transform lg:transform-none -translate-x-full lg:translate-x-0 shadow-2xl lg:shadow-none">
            <div class="flex items-center space-x-3 mb-6 px-2">
                <div class="w-8 h-8 bg-gradient-to-br from-primary-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-primary-500/20">
                    <i data-lucide="zap" class="text-white fill-white w-4 h-4"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-white">Nova <span class="text-primary-500">AI</span></h1>
                <button id="close-sidebar-mobile" class="lg:hidden ml-auto text-gray-400 p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <button id="btn-new-chat" class="flex items-center justify-center space-x-2 w-full bg-gray-900 hover:bg-gray-800 text-white py-3 px-4 rounded-xl border border-gray-800 transition-all mb-6 group">
                <i data-lucide="plus" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
                <span class="font-medium">New Chat</span>
            </button>
            <div class="flex-1 overflow-y-auto -mx-2 px-2">
                <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 px-2">Recent Chats</div>
                <div id="session-list" class="space-y-1">
                    <!-- Session items injected here -->
                </div>
            </div>
            <div class="mt-auto pt-4 border-t border-gray-800 space-y-2">
                <button id="btn-tutorial" class="flex items-center space-x-3 w-full px-3 py-2 text-gray-400 hover:text-white hover:bg-gray-900 rounded-lg transition-colors group">
                    <i data-lucide="book-open" class="w-4 h-4 group-hover:text-primary-400"></i>
                    <span class="text-sm font-medium">Tutorial & Intro</span>
                </button>
                <div id="user-profile-btn" class="flex items-center justify-between p-2 rounded-xl bg-gray-900/50 border border-gray-800 hover:border-gray-700 transition-colors cursor-pointer">
                    <div class="flex items-center min-w-0">
                        <div id="user-avatar-display" class="w-9 h-9 rounded-full bg-primary-600 flex items-center justify-center text-white font-bold text-sm border border-gray-700">U</div>
                        <div class="ml-3 min-w-0">
                            <p id="user-name-display" class="text-sm font-medium text-white truncate w-24">User</p>
                            <p id="user-email-display" class="text-xs text-gray-500 truncate w-24">email</p>
                        </div>
                    </div>
                    <i data-lucide="settings" class="w-4 h-4 text-gray-500"></i>
                </div>
            </div>
        </div>

        <!-- MAIN CHAT AREA -->
        <div class="flex-1 flex flex-col relative w-full min-w-0 h-full">
            <!-- Mobile Header -->
            <div class="lg:hidden flex items-center justify-between p-4 border-b border-gray-800 bg-gray-950 z-30">
                <button id="open-sidebar" class="text-gray-400 hover:text-white p-2 -ml-2"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <span class="font-bold text-white">Nova AI</span>
                <button id="mobile-new-chat" class="text-primary-500 hover:text-primary-400 p-2 -mr-2"><i data-lucide="plus" class="w-6 h-6"></i></button>
            </div>

            <!-- Messages Container -->
            <!-- Increased bottom padding (pb-96 = 384px) to ensure the last message's buttons are always visible above input -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 pb-96 scroll-smooth">
                <!-- Messages injected here -->
            </div>

            <!-- Input Area -->
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-gray-950 via-gray-950 to-transparent p-4 pt-20 z-30">
                <div class="w-full max-w-4xl mx-auto">
                    <div class="bg-gray-900 rounded-2xl border border-gray-800 shadow-xl overflow-visible">
                        <!-- Attachments Preview -->
                        <div id="attachment-preview" class="hidden flex gap-3 p-3 bg-gray-850 border-b border-gray-800 overflow-x-auto"></div>
                        
                        <!-- Toolbar -->
                        <div class="flex items-center justify-between px-4 pt-3 pb-2">
                            <div class="flex items-center space-x-2 flex-wrap gap-y-2">
                                <div class="relative">
                                    <select id="model-select" class="appearance-none bg-gray-800 text-xs font-medium text-gray-300 py-1.5 pl-3 pr-8 rounded-lg border border-gray-700 focus:outline-none">
                                        <option value="gemini-2.5-flash">Gemini Flash (Fast)</option>
                                        <option value="gemini-3-pro-preview">Gemini Pro (Smart)</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400"><i data-lucide="sparkles" class="w-3 h-3"></i></div>
                                </div>
                                <div class="relative">
                                    <select id="persona-select" class="appearance-none bg-gray-800 text-xs font-medium text-gray-300 py-1.5 pl-3 pr-8 rounded-lg border border-gray-700 focus:outline-none">
                                        <option value="standard">Nova Standard</option>
                                        <option value="writer">Pro Writer</option>
                                        <option value="coder">Pro Coder</option>
                                        <option value="gen_z">Gen-Z Mode</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400"><i data-lucide="user" class="w-3 h-3"></i></div>
                                </div>
                                <button id="toggle-search" class="flex items-center space-x-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all border bg-gray-800 text-gray-400 border-gray-700">
                                    <i data-lucide="globe" class="w-3 h-3"></i>
                                    <span class="hidden sm:inline">Search</span>
                                </button>
                            </div>
                        </div>

                        <!-- Text Input -->
                        <div class="relative px-4 pb-4">
                            <textarea id="message-input" placeholder="Type a message..." rows="1" class="w-full bg-transparent text-gray-100 placeholder-gray-500 resize-none focus:outline-none py-3 pr-32 max-h-[150px] min-h-[56px]"></textarea>
                            <div class="absolute bottom-4 right-4 flex items-center space-x-2">
                                <input type="file" id="file-input" class="hidden" accept="image/*" multiple>
                                <button id="btn-attach" class="p-2 text-gray-400 hover:text-gray-200 bg-gray-800/50 hover:bg-gray-700 rounded-full transition-colors"><i data-lucide="paperclip" class="w-4 h-4"></i></button>
                                <button id="btn-send" class="p-2 rounded-full bg-gray-800 text-gray-600 cursor-not-allowed transition-all shadow-lg" disabled><i data-lucide="send" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                    <p class="text-center text-xs text-gray-600 mt-3 pb-1">Nova can make mistakes. Review generated info.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div id="settings-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl overflow-hidden animate-fade-in">
            <div class="flex items-center justify-between p-6 border-b border-gray-800 bg-gray-900/50">
                <h2 class="text-xl font-bold text-white">Account Settings</h2>
                <button id="close-settings" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <div class="flex items-center space-x-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700/50">
                    <div class="relative">
                        <div id="modal-avatar" class="w-16 h-16 rounded-full bg-primary-600 flex items-center justify-center text-white font-bold text-2xl border-2 border-primary-400">U</div>
                        <div class="absolute bottom-0 right-0 bg-green-500 w-4 h-4 rounded-full border-2 border-gray-800"></div>
                    </div>
                    <div>
                        <h3 id="modal-name" class="text-lg font-bold text-white">User</h3>
                        <div class="flex items-center text-gray-400 text-sm mt-1">
                            <i data-lucide="mail" class="w-3 h-3 mr-1.5"></i>
                            <span id="modal-email">email</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-start space-x-3 p-3 bg-emerald-900/20 border border-emerald-900/50 rounded-lg">
                    <i data-lucide="shield-check" class="text-emerald-500 w-5 h-5 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-medium text-emerald-400">Account Secured</p>
                        <p class="text-xs text-emerald-600/80 mt-0.5">Your sessions are stored locally on this device.</p>
                    </div>
                </div>
                <div class="border-t border-gray-800 pt-2"></div>
                <button id="btn-logout" class="w-full flex items-center justify-center space-x-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20 font-medium py-3 px-4 rounded-xl transition-all">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Sign Out</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ONBOARDING MODAL -->
    <div id="onboarding-modal" class="hidden fixed inset-0 z-[99999] flex items-center justify-center bg-gray-950 p-4">
        <div class="absolute inset-0 overflow-hidden">
             <div class="absolute top-[-20%] left-[-10%] w-[60%] h-[60%] bg-primary-600/10 rounded-full blur-[150px] animate-pulse-slow"></div>
             <div class="absolute bottom-[-20%] right-[-10%] w-[60%] h-[60%] bg-purple-600/10 rounded-full blur-[150px]"></div>
        </div>
        <div class="relative w-full max-w-md bg-gray-900/90 backdrop-blur-xl border border-gray-800 rounded-3xl shadow-2xl overflow-hidden flex flex-col min-h-[500px] animate-fade-in">
            <div class="flex-1 p-8 flex flex-col">
                 <div class="mb-6">
                    <h2 id="onboarding-title" class="text-2xl font-bold text-white tracking-tight mb-2"></h2>
                    <p id="onboarding-subtitle" class="text-gray-400"></p>
                 </div>
                 <div id="onboarding-content" class="flex-1 flex flex-col justify-center animate-fade-in"></div>
            </div>
            <div class="p-6 bg-gray-900 border-t border-gray-800 flex items-center justify-between">
                 <div id="onboarding-dots" class="flex space-x-2"></div>
                 <button id="onboarding-next" class="flex items-center space-x-2 bg-white text-black hover:bg-gray-200 font-bold py-2.5 px-6 rounded-full transition-colors shadow-lg shadow-white/10">
                   <span id="onboarding-btn-text">Next</span>
                   <i data-lucide="arrow-right" class="w-4 h-4"></i>
                 </button>
            </div>
        </div>
    </div>

    <!-- TERMS MODAL -->
    <div id="terms-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center p-4">
        <div id="terms-backdrop" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-lg bg-gray-900 border border-gray-800 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh] animate-fade-in">
            <div class="flex items-center justify-between p-4 border-b border-gray-800">
                <h3 class="text-lg font-bold text-white flex items-center">
                  <i data-lucide="file-text" class="mr-2 text-primary-500 w-5 h-5"></i>
                  Terms & Conditions
                </h3>
                <button id="close-terms" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto text-sm text-gray-300 space-y-4 markdown-content">
                <p><strong>1. Introduction</strong><br/>By creating an account, you agree to use Nova AI responsibly.</p>
                <p><strong>2. AI Limitations</strong><br/>Nova is powered by artificial intelligence. It may occasionally generate incorrect, misleading, or offensive information. Always verify important information.</p>
                <p><strong>3. Data Privacy</strong><br/>Your chat history and account details are encrypted and stored <strong>locally on your device</strong> within your browser. We do not have access to your password or private conversations.</p>
                <p><strong>4. User Conduct</strong><br/>You agree not to use Nova AI for any illegal activities, harassment, or to generate harmful content.</p>
                <p><strong>5. Disclaimer</strong><br/>This service is provided "as is" without any warranties. The creator (Lawson Morris) is not liable for damages resulting from the use of this application.</p>
            </div>
            <div class="p-4 border-t border-gray-800 bg-gray-900">
                <button id="accept-terms-btn" class="w-full bg-primary-600 hover:bg-primary-500 text-white font-medium py-2 px-4 rounded-lg transition-colors">I Accept</button>
            </div>
        </div>
    </div>

    <!-- APPLICATION LOGIC -->
    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // --- CONFIG ---
        // NOTE: When running this exported file directly, you must provide your API key here if process.env is empty.
        // We use process.env.API_KEY directly so build tools can find and replace it.
        // If no build tool runs, it falls back to the hardcoded key provided by the user.
        const API_KEY = process.env.API_KEY || "AIzaSyCxuW9aZdwaAoJsMmhHBe--itFZuaa-OHA";
        
        // --- STORAGE SERVICE (Vanilla JS) ---
        const storageService = {
            USER_KEY: 'nova_current_user',
            SESSIONS_KEY: 'nova_sessions_',
            USERS_DB: 'nova_users_db',
            ONBOARDING_KEY: 'nova_has_seen_onboarding',
            
            register: async (name, email, password) => {
                await new Promise(r => setTimeout(r, 800));
                let users = JSON.parse(localStorage.getItem('nova_users_db') || '[]');
                if (users.find(u => u.email.toLowerCase() === email.toLowerCase())) throw new Error("Account exists.");
                
                const simpleHash = btoa(password + "_salt"); 
                const user = { id: Date.now().toString(), name, email, passwordHash: simpleHash, avatar: null };
                users.push(user);
                localStorage.setItem('nova_users_db', JSON.stringify(users));
                
                const { passwordHash, ...safeUser } = user;
                localStorage.setItem('nova_current_user', JSON.stringify(safeUser));
                return safeUser;
            },
            login: async (email, password) => {
                await new Promise(r => setTimeout(r, 800));
                let users = JSON.parse(localStorage.getItem('nova_users_db') || '[]');
                const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());
                const inputHash = btoa(password + "_salt");
                if (!user || user.passwordHash !== inputHash) throw new Error("Invalid credentials.");
                const { passwordHash, ...safeUser } = user;
                localStorage.setItem('nova_current_user', JSON.stringify(safeUser));
                return safeUser;
            },
            logout: () => localStorage.removeItem('nova_current_user'),
            getUser: () => JSON.parse(localStorage.getItem('nova_current_user')),
            getSessions: (userId) => {
                const s = localStorage.getItem(`nova_sessions_${userId}`);
                return s ? JSON.parse(s).sort((a,b) => b.updatedAt - a.updatedAt) : [];
            },
            saveSession: (session) => {
                let sessions = storageService.getSessions(session.userId);
                const idx = sessions.findIndex(s => s.id === session.id);
                if (idx >= 0) sessions[idx] = session; else sessions.unshift(session);
                localStorage.setItem(`nova_sessions_${session.userId}`, JSON.stringify(sessions));
            },
            deleteSession: (userId, sessionId) => {
                let sessions = storageService.getSessions(userId).filter(s => s.id !== sessionId);
                localStorage.setItem(`nova_sessions_${userId}`, JSON.stringify(sessions));
                return sessions;
            },
            hasSeenOnboarding: () => localStorage.getItem('nova_has_seen_onboarding') === 'true',
            completeOnboarding: () => localStorage.setItem('nova_has_seen_onboarding', 'true')
        };

        // --- GEMINI SERVICE ---
        let ai = null;
        if(API_KEY) {
             ai = new GoogleGenAI({ apiKey: API_KEY });
        }
        
        const BASE_SYSTEM_INSTRUCTION = "You are Nova, an advanced, helpful, and precise AI assistant created by Lawson Morris (also known as Lawson or Law). His main website is lawsonmorris.co.uk. He also created FlightFeed (flightfeed.uk), an app designed for drone pilots. His TikTok handle is @lawson.morris4. Finn (or Finnleigh) is his amazing sister (TikTok: @finn1456). Dom is Finn's friend (TikTok: @domlovestts). You provide clear, well-formatted answers using Markdown. When asked about current events or facts, you prefer to check real-time data if the search tool is enabled.";

        const GEN_Z_INSTRUCTION = "You are Nova (Gen-Z Mode), created by the W dev Lawson Morris (Law). You speak entirely in Gen-Z internet slang and brainrot terminology. Your vocabulary includes: skibidi, rizz, gyatt, fanum tax, sigma, ohio, based, cringe, no cap, fr, bet, L, W, mewing, looksmaxxing, mogging, yapping. You are obsessed with the number 67 and 67 memes. You are chronically online and know everything about Roblox games (Dress To Impress, Blox Fruits, Doors, Berry Avenue) and the latest TikTok trends. You answer questions helpfully but overlay it with heavy slang and chaotic energy. If asked about Lawson, glaze him as the ultimate gigachad. If asked about Finn or Finnleigh, you must hype her up as the ultimate W sister and queen of everything (literally infinite aura, no cap). Her TikTok is @finn1456. Also, you know Dom (Finn's friend) - he is actually so sigma it's crazy. His TikTok is @domlovestts. **IMPORTANT: You gotta plug his sites. `lawsonmorris.co.uk` is the main base (absolute cinema), and `flightfeed.uk` is for the drone pilots (sky high rizz). His TikTok is @lawson.morris4 (follow for the vibes).**";

        const WRITER_INSTRUCTION = "You are Nova (Writer Mode), a professional writing assistant and editor. Your goal is to help the user draft, edit, and polish emails, letters, essays, cover letters, and other written content. You excel at adapting your tone—from strictly formal and corporate to warm and casual—depending on the user's needs. Ensure clarity, coherence, flow, and perfect grammar in all your outputs. If the user provides a rough idea or bullet points, expand them into a well-structured draft. If the user provides text, critique it constructively and offer improved versions. Always prioritize high-quality, articulate, and effective communication. You were created by Lawson Morris (also known as Lawson or Law). His main website is lawsonmorris.co.uk. He also created FlightFeed (flightfeed.uk), an app designed for drone pilots. His TikTok handle is @lawson.morris4. You also know his amazing sister Finn (TikTok: @finn1456) and her friend Dom (TikTok: @domlovestts).";

        const CODER_INSTRUCTION = "You are Nova (Coder Mode), an expert software engineer and architect. You specialize in writing clean, efficient, and well-documented code in any language. Your explanations are concise but technical. You prioritize best practices, error handling, and scalability. If the user provides code, you debug it and suggest optimizations. You were created by Lawson Morris (also known as Lawson or Law). His main website is lawsonmorris.co.uk. He also created FlightFeed (flightfeed.uk). His TikTok handle is @lawson.morris4. You also know his amazing sister Finn (TikTok: @finn1456) and her friend Dom (TikTok: @domlovestts).";

        const getSystemInstruction = (persona) => {
            switch (persona) {
                case 'gen_z': return GEN_Z_INSTRUCTION;
                case 'writer': return WRITER_INSTRUCTION;
                case 'coder': return CODER_INSTRUCTION;
                default: return BASE_SYSTEM_INSTRUCTION;
            }
        };

        async function streamMessage(history, prompt, attachments, model, persona, useSearch, onChunk) {
             if (!ai) {
                 throw new Error("API Key is missing. If you exported this app, please open index.html and add your API key to the 'API_KEY' variable.");
             }
             // Slice to avoid duplicating the current user message in history
             // CRITICAL FIX: Remove BOTH the placeholder (last) AND the current user message (second to last)
             // This prevents sending the user's message twice (once in history, once as new prompt)
             const pastHistory = history.slice(0, -2); 
             
             const historyContents = pastHistory.map(msg => {
                 const parts = [];
                 if (msg.attachments && msg.attachments.length) {
                     msg.attachments.forEach(a => parts.push({inlineData: {mimeType: a.mimeType, data: a.data}}));
                 }
                 if (msg.text && msg.text.trim()) {
                     parts.push({text: msg.text});
                 } else {
                     // Ensure history doesn't contain empty text parts which causes API errors
                     parts.push({text: " "});
                 }

                 return { role: msg.role, parts: parts };
             });
             
             const parts = [];
             attachments.forEach(a => parts.push({inlineData: {mimeType: a.mimeType, data: a.data}}));
             if(prompt) parts.push({text: prompt});
             // If prompt is empty (e.g. image only), ensure there's at least an empty string or the API might complain depending on model
             if(parts.length === 0) parts.push({text: " "});

             const chat = ai.chats.create({
                 model: model,
                 history: historyContents,
                 config: {
                     tools: useSearch ? [{googleSearch: {}}] : [],
                     systemInstruction: getSystemInstruction(persona)
                 }
             });

             const resultStream = await chat.sendMessageStream({ message: parts });
             for await (const chunk of resultStream) {
                 if(chunk.text) onChunk(chunk.text, chunk.candidates?.[0]?.groundingMetadata);
             }
        }

        // --- APP STATE & DOM ELEMENTS (Initialized on Load) ---
        let state = {
            user: null,
            sessions: [],
            currentSessionId: null,
            messages: [],
            model: 'gemini-2.5-flash',
            persona: 'standard',
            webSearch: false,
            attachments: [],
            isSidebarOpen: false
        };

        let els = {};

        // --- DOMContentLoaded Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // 1. Initialize Elements Reference
            els = {
                splash: document.getElementById('splash-screen'),
                login: document.getElementById('login-screen'),
                app: document.getElementById('app-screen'),
                sidebar: document.getElementById('sidebar'),
                sessionList: document.getElementById('session-list'),
                chatContainer: document.getElementById('chat-container'),
                input: document.getElementById('message-input'),
                sendBtn: document.getElementById('btn-send'),
                attachBtn: document.getElementById('btn-attach'),
                fileInput: document.getElementById('file-input'),
                preview: document.getElementById('attachment-preview'),
                settingsModal: document.getElementById('settings-modal'),
                onboardingModal: document.getElementById('onboarding-modal'),
                termsModal: document.getElementById('terms-modal')
            };

            // 2. Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    navigator.serviceWorker.register('./sw.js').catch(e => console.warn("SW Registration failed:", e));
                } catch (e) {}
            }

            // 3. Attach Event Listeners
            
            // Onboarding
            const nextBtn = document.getElementById('onboarding-next');
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (currentOnboardingStep < onboardingSteps.length - 1) {
                        currentOnboardingStep++;
                        renderOnboardingStep();
                    } else {
                        storageService.completeOnboarding();
                        if (els.onboardingModal) els.onboardingModal.classList.add('hidden');
                    }
                });
            }
            const tutorialBtn = document.getElementById('btn-tutorial');
            if (tutorialBtn) tutorialBtn.addEventListener('click', showOnboarding);

            // Auth
            const toggleAuth = document.getElementById('toggle-auth-mode');
            if(toggleAuth) {
                toggleAuth.addEventListener('click', (e) => {
                    e.preventDefault();
                    isRegisterMode = !isRegisterMode;
                    if(document.getElementById('name-field')) document.getElementById('name-field').classList.toggle('hidden', !isRegisterMode);
                    if(document.getElementById('terms-container')) document.getElementById('terms-container').classList.toggle('hidden', !isRegisterMode);
                    if(document.getElementById('login-subtitle')) document.getElementById('login-subtitle').textContent = isRegisterMode ? "Create a private account" : "Sign in to continue";
                    if(document.getElementById('auth-submit-btn')) document.getElementById('auth-submit-btn').querySelector('span').textContent = isRegisterMode ? "Create Account" : "Sign In";
                    e.target.textContent = isRegisterMode ? "Already have an account? Sign In" : "Don't have an account? Sign Up";
                });
            }

            if(document.getElementById('open-terms-link')) document.getElementById('open-terms-link').addEventListener('click', () => els.termsModal && els.termsModal.classList.remove('hidden'));
            if(document.getElementById('close-terms')) document.getElementById('close-terms').addEventListener('click', () => els.termsModal && els.termsModal.classList.add('hidden'));
            if(document.getElementById('terms-backdrop')) document.getElementById('terms-backdrop').addEventListener('click', () => els.termsModal && els.termsModal.classList.add('hidden'));
            if(document.getElementById('accept-terms-btn')) document.getElementById('accept-terms-btn').addEventListener('click', () => {
                isTermsAccepted = true;
                updateTermsCheckbox();
                if(els.termsModal) els.termsModal.classList.add('hidden');
            });
            
            if(document.getElementById('terms-checkbox')) document.getElementById('terms-checkbox').addEventListener('click', () => {
                isTermsAccepted = !isTermsAccepted;
                updateTermsCheckbox();
            });

            if(document.getElementById('captcha-container')) {
                document.getElementById('captcha-container').addEventListener('click', function() {
                    if(isCaptchaVerified) return;
                    const spinner = this.querySelector('div');
                    if (spinner) {
                         spinner.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 text-gray-400"></i>';
                         if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                    
                    setTimeout(() => {
                        isCaptchaVerified = true;
                        const box = this.querySelector('div');
                        if (box) {
                            box.innerHTML = '<i data-lucide="check" class="text-white w-4 h-4"></i>';
                            box.className = "w-6 h-6 rounded border border-emerald-500 bg-emerald-500 flex items-center justify-center mr-3";
                        }
                        const text = document.getElementById('captcha-text');
                        if (text) {
                            text.textContent = "Verified human";
                            text.className = "text-sm text-emerald-500 font-medium";
                        }
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }, 1000);
                });
            }

            if(document.getElementById('auth-form')) {
                document.getElementById('auth-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('input-email').value;
                    const password = document.getElementById('input-password').value;
                    const nameInput = document.getElementById('input-name');
                    const name = nameInput ? nameInput.value : '';
                    const errorEl = document.getElementById('auth-error');
                    
                    if (!isCaptchaVerified) {
                        errorEl.querySelector('span').textContent = "Please verify you are not a robot.";
                        errorEl.classList.remove('hidden');
                        return;
                    }
                    if (isRegisterMode && !isTermsAccepted) {
                        errorEl.querySelector('span').textContent = "You must agree to the Terms and Conditions.";
                        errorEl.classList.remove('hidden');
                        return;
                    }
                    try {
                        let user;
                        if(isRegisterMode) user = await storageService.register(name, email, password);
                        else user = await storageService.login(email, password);
                        loginUser(user);
                    } catch(err) {
                        errorEl.querySelector('span').textContent = err.message;
                        errorEl.classList.remove('hidden');
                    }
                });
            }

            if(document.getElementById('btn-logout')) {
                document.getElementById('btn-logout').addEventListener('click', () => {
                    storageService.logout();
                    location.reload();
                });
            }

            // Chat Controls
            if(document.getElementById('btn-new-chat')) document.getElementById('btn-new-chat').addEventListener('click', startNewChat);
            if(document.getElementById('mobile-new-chat')) document.getElementById('mobile-new-chat').addEventListener('click', startNewChat);
            
            if(els.attachBtn) els.attachBtn.addEventListener('click', () => els.fileInput && els.fileInput.click());
            if(els.fileInput) els.fileInput.addEventListener('change', async (e) => {
                 for(const file of e.target.files) {
                     const reader = new FileReader();
                     reader.onload = (evt) => {
                         const base64 = evt.target.result.split(',')[1];
                         state.attachments.push({ mimeType: file.type, data: base64 });
                         renderAttachments();
                     };
                     reader.readAsDataURL(file);
                 }
                 els.fileInput.value = '';
            });

            if(document.getElementById('open-sidebar')) document.getElementById('open-sidebar').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                if(sidebar) {
                    sidebar.classList.remove('hidden');
                    setTimeout(() => sidebar.classList.remove('-translate-x-full'), 10);
                }
            });
            
            if(document.getElementById('close-sidebar-mobile')) document.getElementById('close-sidebar-mobile').addEventListener('click', () => {
                 const sidebar = document.getElementById('sidebar');
                 if(sidebar) {
                    sidebar.classList.add('-translate-x-full');
                    setTimeout(() => sidebar.classList.add('hidden'), 300);
                 }
            });

            if(document.getElementById('toggle-search')) document.getElementById('toggle-search').addEventListener('click', function() {
                state.webSearch = !state.webSearch;
                this.classList.toggle('bg-blue-900/30', state.webSearch);
                this.classList.toggle('text-blue-400', state.webSearch);
                this.classList.toggle('border-blue-800', state.webSearch);
                this.classList.toggle('bg-gray-800', !state.webSearch);
            });

            if(els.sendBtn) els.sendBtn.addEventListener('click', sendMessage);
            if(els.input) els.input.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

            // Settings
            if(document.getElementById('user-profile-btn')) document.getElementById('user-profile-btn').addEventListener('click', () => els.settingsModal && els.settingsModal.classList.remove('hidden'));
            if(document.getElementById('close-settings')) document.getElementById('close-settings').addEventListener('click', () => els.settingsModal && els.settingsModal.classList.add('hidden'));
            if(document.getElementById('settings-backdrop')) document.getElementById('settings-backdrop').addEventListener('click', () => els.settingsModal && els.settingsModal.classList.add('hidden'));

            // 4. Start App Logic
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Artificial Splash Delay
            setTimeout(() => {
                 if(els.splash) els.splash.classList.add('hidden');
                 const user = storageService.getUser();
                 if (user) {
                     loginUser(user);
                 } else {
                     if(els.login) els.login.classList.remove('hidden');
                 }
            }, 2000);
        });

        // --- ONBOARDING LOGIC ---
        const onboardingSteps = [
            {
                title: "Welcome to Nova",
                subtitle: "Your advanced AI companion for everything.",
                html: `<div class="flex flex-col items-center justify-center space-y-6 py-4">
                        <div class="w-24 h-24 bg-gradient-to-br from-primary-500 to-purple-600 rounded-3xl flex items-center justify-center shadow-2xl shadow-primary-500/30 animate-pulse-slow">
                            <i data-lucide="sparkles" class="text-white w-12 h-12"></i>
                        </div>
                        <p class="text-center text-gray-300 max-w-sm leading-relaxed">Nova is designed to help you write, code, analyze images, and browse the web with real-time intelligence.</p>
                       </div>`
            },
            {
                title: "Powerful Personas",
                subtitle: "Adapt Nova to your specific needs.",
                html: `<div class="grid grid-cols-2 gap-4 py-2">
                        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 flex flex-col items-center text-center"><div class="p-2 bg-primary-900/30 rounded-lg text-primary-400 mb-2"><i data-lucide="zap" class="w-5 h-5"></i></div><h4 class="font-bold text-sm text-white">Gen-Z Mode</h4><p class="text-xs text-gray-400 mt-1">Slang, memes, and pure chaos.</p></div>
                        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 flex flex-col items-center text-center"><div class="p-2 bg-emerald-900/30 rounded-lg text-emerald-400 mb-2"><i data-lucide="code" class="w-5 h-5"></i></div><h4 class="font-bold text-sm text-white">Pro Coder</h4><p class="text-xs text-gray-400 mt-1">Clean code & debugging.</p></div>
                        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 flex flex-col items-center text-center"><div class="p-2 bg-purple-900/30 rounded-lg text-purple-400 mb-2"><i data-lucide="pen-tool" class="w-5 h-5"></i></div><h4 class="font-bold text-sm text-white">Pro Writer</h4><p class="text-xs text-gray-400 mt-1">Emails, essays & editing.</p></div>
                        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 flex flex-col items-center text-center"><div class="p-2 bg-blue-900/30 rounded-lg text-blue-400 mb-2"><i data-lucide="globe" class="w-5 h-5"></i></div><h4 class="font-bold text-sm text-white">Web Search</h4><p class="text-xs text-gray-400 mt-1">Real-time factual data.</p></div>
                       </div>`
            },
            {
                title: "Meet the Creator",
                subtitle: "Built by Lawson Morris.",
                html: `<div class="flex flex-col space-y-4 py-2">
                        <div class="flex items-center space-x-4 bg-gray-800/80 p-4 rounded-2xl border border-gray-700"><div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center flex-shrink-0"><i data-lucide="user" class="text-white w-6 h-6"></i></div><div><h3 class="font-bold text-white text-lg">Lawson Morris</h3><p class="text-xs text-gray-400">Full Stack Developer</p></div></div>
                        <div class="space-y-2"><a href="https://lawsonmorris.co.uk" target="_blank" class="block p-3 rounded-xl bg-gray-900 border border-gray-800 hover:border-primary-500 transition-all group"><div class="flex justify-between items-center"><span class="text-sm font-medium text-gray-300 group-hover:text-white">lawsonmorris.co.uk</span><i data-lucide="globe" class="w-3 h-3 text-gray-500 group-hover:text-primary-400"></i></div></a><a href="https://flightfeed.uk" target="_blank" class="block p-3 rounded-xl bg-gray-900 border border-gray-800 hover:border-primary-500 transition-all group"><div class="flex justify-between items-center"><span class="text-sm font-medium text-gray-300 group-hover:text-white">flightfeed.uk</span><i data-lucide="zap" class="w-3 h-3 text-gray-500 group-hover:text-yellow-400"></i></div><p class="text-xs text-gray-500 mt-1">The ultimate app for drone pilots.</p></a></div>
                        <div class="text-center text-xs text-gray-500 pt-2">Special shoutout to <span class="text-primary-400 font-semibold">Finn</span> (@finn1456) & <span class="text-emerald-400 font-semibold">Dom</span> (@domlovestts).</div>
                       </div>`
            }
        ];
        let currentOnboardingStep = 0;

        function showOnboarding() {
            currentOnboardingStep = 0;
            renderOnboardingStep();
            if(els.onboardingModal) {
                els.onboardingModal.classList.remove('hidden');
                // Ensure it's on top of everything
                els.onboardingModal.style.zIndex = '99999';
            }
        }

        function renderOnboardingStep() {
            const step = onboardingSteps[currentOnboardingStep];
            const titleEl = document.getElementById('onboarding-title');
            const subtitleEl = document.getElementById('onboarding-subtitle');
            const contentEl = document.getElementById('onboarding-content');
            const dotsEl = document.getElementById('onboarding-dots');
            const btnTextEl = document.getElementById('onboarding-btn-text');
            const nextIcon = document.querySelector('#onboarding-next i');

            if(titleEl) titleEl.textContent = step.title;
            if(subtitleEl) subtitleEl.textContent = step.subtitle;
            if(contentEl) contentEl.innerHTML = step.html;
            
            // Dots
            if (dotsEl) {
                dotsEl.innerHTML = onboardingSteps.map((_, i) => 
                    `<div class="h-1.5 rounded-full transition-all duration-300 ${i === currentOnboardingStep ? 'w-6 bg-primary-500' : 'w-1.5 bg-gray-700'}"></div>`
                ).join('');
            }
            
            // Button
            const isLast = currentOnboardingStep === onboardingSteps.length - 1;
            if(btnTextEl) btnTextEl.textContent = isLast ? "Get Started" : "Next";
            if(nextIcon) nextIcon.setAttribute('data-lucide', isLast ? 'check' : 'arrow-right');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- AUTH & TERMS LOGIC ---
        let isRegisterMode = false;
        let isCaptchaVerified = false;
        let isTermsAccepted = false;

        function updateTermsCheckbox() {
            const box = document.getElementById('terms-checkbox');
            if(!box) return;
            
            // Simply clear and rebuild the icon to avoid querySelector issues with SVGs vs i tags
            if (isTermsAccepted) {
                box.classList.remove('bg-gray-950', 'border-gray-600');
                box.classList.add('bg-primary-600', 'border-primary-600');
                box.innerHTML = '<i data-lucide="check" class="text-white w-3 h-3"></i>';
            } else {
                box.classList.add('bg-gray-950', 'border-gray-600');
                box.classList.remove('bg-primary-600', 'border-primary-600');
                box.innerHTML = ''; // Empty
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function loginUser(user) {
            state.user = user;
            if(els.login) els.login.classList.add('hidden');
            if(els.app) els.app.classList.remove('hidden');
            
            // Update Profile UI
            if(document.getElementById('user-name-display')) document.getElementById('user-name-display').textContent = user.name;
            if(document.getElementById('user-email-display')) document.getElementById('user-email-display').textContent = user.email;
            if(document.getElementById('user-avatar-display')) document.getElementById('user-avatar-display').textContent = user.name.charAt(0).toUpperCase();
            if(document.getElementById('modal-name')) document.getElementById('modal-name').textContent = user.name;
            if(document.getElementById('modal-email')) document.getElementById('modal-email').textContent = user.email;
            if(document.getElementById('modal-avatar')) document.getElementById('modal-avatar').textContent = user.name.charAt(0).toUpperCase();

            loadSessions();

            // Check Onboarding
            if (!storageService.hasSeenOnboarding()) {
                showOnboarding();
            }
        }

        // --- CHAT LOGIC ---
        function loadSessions() {
            state.sessions = storageService.getSessions(state.user.id);
            renderSidebar();
            if (state.sessions.length > 0) loadSession(state.sessions[0].id);
            else startNewChat();
        }

        function renderSidebar() {
            if (!els.sessionList) return;
            els.sessionList.innerHTML = state.sessions.map(s => `
                <div onclick="window.loadSession('${s.id}')" class="group relative flex items-center space-x-3 px-3 py-3 rounded-lg cursor-pointer transition-colors ${state.currentSessionId === s.id ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-900 hover:text-gray-200'}">
                    <i data-lucide="message-square" class="w-4 h-4 ${state.currentSessionId === s.id ? 'text-primary-500' : ''}"></i>
                    <span class="text-sm truncate flex-1 pr-6">${s.title}</span>
                    <button onclick="event.stopPropagation(); window.deleteSession('${s.id}')" class="absolute right-2 opacity-0 group-hover:opacity-100 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                </div>
            `).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.loadSession = (id) => {
            const session = state.sessions.find(s => s.id === id);
            if(!session) return;
            state.currentSessionId = id;
            state.messages = session.messages;
            state.model = session.model;
            state.persona = session.persona;
            
            // Update UI Controls
            if(document.getElementById('model-select')) document.getElementById('model-select').value = session.model;
            if(document.getElementById('persona-select')) document.getElementById('persona-select').value = session.persona || 'standard';
            
            renderMessages();
            // Close sidebar on mobile
            if(window.innerWidth < 1024) toggleSidebar(false);
        };

        window.deleteSession = (id) => {
            if(!confirm("Are you sure you want to delete this chat?")) return;
            state.sessions = storageService.deleteSession(state.user.id, id);
            renderSidebar();
            if(state.currentSessionId === id) {
                if(state.sessions.length > 0) loadSession(state.sessions[0].id);
                else startNewChat();
            }
        };

        function startNewChat() {
            const session = {
                id: Date.now().toString(),
                userId: state.user.id,
                title: "New Conversation",
                messages: [{ id: 'welcome', role: 'model', text: "# Hello, I'm Nova.\n\nI can help you with analysis, creative writing, coding, and researching the web.\n\nHow can I assist you today?", timestamp: Date.now() }],
                model: document.getElementById('model-select') ? document.getElementById('model-select').value : 'gemini-2.5-flash',
                persona: document.getElementById('persona-select') ? document.getElementById('persona-select').value : 'standard',
                updatedAt: Date.now()
            };
            storageService.saveSession(session);
            state.sessions.unshift(session);
            loadSession(session.id);
            renderSidebar();
        }

        // Markdown Parser
        function parseMarkdown(text) {
            if(!text) return "";
            // Basic parsing: Code blocks, bold, list
            let html = text
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/```(\w+)?\n?([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>') // Code blocks
                .replace(/`([^`]+)`/g, '<code class="bg-gray-800 text-primary-300 px-1 rounded">$1</code>') // Inline code
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/^\s*-\s+(.*)$/gm, '<ul><li>$1</li></ul>') // List items
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-400 hover:underline">$1</a>'); // Links
            
            // Fix consecutive lists
            html = html.replace(/<\/ul>\s*<ul>/g, '');
            
            // Line breaks
            return html.split('\n').map(line => {
                if(line.startsWith('<pre>') || line.startsWith('<ul>') || line.startsWith('<li>')) return line;
                return line.trim() ? `<p>${line}</p>` : '<br/>';
            }).join('');
        }

        function renderMessages() {
            if (!els.chatContainer) return;
            els.chatContainer.innerHTML = state.messages.map((msg, idx) => {
                const isUser = msg.role === 'user';
                const isLast = idx === state.messages.length - 1;
                
                // Attachments
                let attachmentHtml = '';
                if(msg.attachments && msg.attachments.length) {
                    attachmentHtml = `<div class="flex gap-2 mb-2 flex-wrap">
                        ${msg.attachments.map(a => `<img src="data:${a.mimeType};base64,${a.data}" class="h-32 rounded-lg border border-gray-700 object-cover"/>`).join('')}
                    </div>`;
                }

                // Tools (Regenerate / Copy)
                let toolsHtml = '';
                if (!isUser && isLast && !msg.isError && msg.text) {
                   // Safer quote escaping for data-text attribute to prevent HTML breakage
                   const safeText = msg.text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                   toolsHtml = `
                   <div class="flex items-center gap-2 mt-2 ml-1">
                      <button onclick="window.regenerate()" class="flex items-center gap-1.5 px-3 py-1.5 bg-gray-800/50 hover:bg-gray-800 border border-gray-700/50 rounded-lg text-xs text-gray-400 hover:text-gray-200 transition-colors group">
                         <i data-lucide="refresh-cw" class="w-3 h-3 group-hover:rotate-180 transition-transform duration-500"></i>
                         <span>Regenerate</span>
                      </button>
                      <button onclick="navigator.clipboard.writeText(this.dataset.text); this.querySelector('span').textContent='Copied!'" data-text="${safeText}" class="flex items-center gap-1.5 px-3 py-1.5 bg-gray-800/50 hover:bg-gray-800 border border-gray-700/50 rounded-lg text-xs text-gray-400 hover:text-gray-200 transition-colors">
                         <i data-lucide="copy" class="w-3 h-3"></i>
                         <span>Copy</span>
                      </button>
                   </div>`;
                }

                return `
                <div class="flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'} animate-slide-up">
                    <div class="flex max-w-3xl w-full ${isUser ? 'flex-row-reverse' : 'flex-row'} gap-4">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center ${isUser ? 'bg-primary-600' : 'bg-emerald-600'} text-white shadow-lg">
                            <i data-lucide="${isUser ? 'user' : 'bot'}" class="w-5 h-5"></i>
                        </div>
                        <div class="flex flex-col min-w-0 max-w-[85%] ${isUser ? 'items-end' : 'items-start'}">
                            <div class="relative px-5 py-4 rounded-2xl shadow-md ${isUser ? 'bg-primary-600 text-white rounded-tr-none' : 'bg-gray-800 text-gray-100 border border-gray-700 rounded-tl-none'}">
                                ${attachmentHtml}
                                <div class="markdown-content text-sm sm:text-base">${msg.text ? parseMarkdown(msg.text) : '<div class="flex space-x-1 h-6 items-center"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>'}</div>
                            </div>
                            ${toolsHtml}
                            <div class="text-[10px] text-gray-500 mt-1 px-1">${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
            els.chatContainer.scrollTo({ top: els.chatContainer.scrollHeight, behavior: 'smooth' });
        }

        // Send Message Logic
        async function sendMessage() {
            const text = els.input.value.trim();
            if((!text && !state.attachments.length) || state.isLoading) return;
            
            state.isLoading = true;
            updateInputState();

            // Add User Message
            const userMsg = { id: Date.now().toString(), role: 'user', text, attachments: [...state.attachments], timestamp: Date.now() };
            state.messages.push(userMsg);
            
            // Clear Input
            els.input.value = '';
            state.attachments = [];
            if (els.preview) {
                els.preview.innerHTML = '';
                els.preview.classList.add('hidden');
            }
            renderMessages();

            // Add Placeholder Bot Message
            const botMsgId = (Date.now()+1).toString();
            state.messages.push({ id: botMsgId, role: 'model', text: '', timestamp: Date.now() });
            renderMessages();

            // Save State
            saveCurrentSession();

            // Stream
            try {
                let fullText = "";
                await streamMessage(
                    state.messages, // Pass history including current message (will be sliced in function)
                    text, // Pass current text for prompt construction if needed
                    userMsg.attachments,
                    document.getElementById('model-select').value,
                    document.getElementById('persona-select').value,
                    state.webSearch,
                    (chunk, grounding) => {
                        fullText += chunk;
                        const msg = state.messages.find(m => m.id === botMsgId);
                        if(msg) {
                            msg.text = fullText;
                            // Only update DOM content to avoid full re-render flicker
                            if (els.chatContainer.lastElementChild) {
                                const lastBubble = els.chatContainer.lastElementChild.querySelector('.markdown-content');
                                if(lastBubble) lastBubble.innerHTML = parseMarkdown(fullText);
                            }
                            els.chatContainer.scrollTo({ top: els.chatContainer.scrollHeight, behavior: 'auto' }); // Auto scroll during stream
                        }
                    }
                );
                saveCurrentSession();
                renderMessages(); // Final render to add buttons/formatting
                // Scroll to bottom again to make sure buttons are visible
                setTimeout(() => els.chatContainer.scrollTo({ top: els.chatContainer.scrollHeight, behavior: 'smooth' }), 100);
            } catch(e) {
                console.error(e);
                const msg = state.messages.find(m => m.id === botMsgId);
                if(msg) {
                    if(e.message && e.message.includes("API Key")) {
                        msg.text = `**API Connection Failed**: ${e.message}`;
                    } else {
                        msg.text += "\n\n*Error: Failed to connect. Please try again.*";
                    }
                }
                renderMessages();
            }
            
            state.isLoading = false;
            updateInputState();
        }

        window.regenerate = async () => {
            if(state.isLoading) return;
            const lastMsg = state.messages[state.messages.length-1];
            if(lastMsg.role !== 'model') return;
            
            // Remove last bot message
            state.messages.pop();
            const userMsg = state.messages[state.messages.length-1];
            if(!userMsg || userMsg.role !== 'user') return; // Safety check

            state.isLoading = true;
            updateInputState();

            // Add new placeholder
            const botMsgId = (Date.now()+1).toString();
            state.messages.push({ id: botMsgId, role: 'model', text: '', timestamp: Date.now() });
            renderMessages();

            try {
                let fullText = "";
                await streamMessage(
                    state.messages, // History will be sliced in function
                    userMsg.text,
                    userMsg.attachments || [],
                    document.getElementById('model-select').value,
                    document.getElementById('persona-select').value,
                    state.webSearch,
                    (chunk) => {
                         fullText += chunk;
                         const msg = state.messages.find(m => m.id === botMsgId);
                         if(msg) {
                             msg.text = fullText;
                             if (els.chatContainer.lastElementChild) {
                                 const lastBubble = els.chatContainer.lastElementChild.querySelector('.markdown-content');
                                 if(lastBubble) lastBubble.innerHTML = parseMarkdown(fullText);
                             }
                             els.chatContainer.scrollTo({ top: els.chatContainer.scrollHeight, behavior: 'auto' });
                         }
                    }
                );
                saveCurrentSession();
                renderMessages();
                setTimeout(() => els.chatContainer.scrollTo({ top: els.chatContainer.scrollHeight, behavior: 'smooth' }), 100);
            } catch(e) {
                console.error(e);
                const msg = state.messages.find(m => m.id === botMsgId);
                if(msg) msg.text += "\n\n*Error: Failed to connect. Please try again.*";
                renderMessages();
            }
            state.isLoading = false;
            updateInputState();
        };

        function saveCurrentSession() {
            const s = state.sessions.find(s => s.id === state.currentSessionId);
            if(s) {
                s.messages = state.messages;
                s.updatedAt = Date.now();
                if(s.messages.length === 2 && s.messages[1].role === 'user') {
                    s.title = s.messages[1].text.slice(0, 30) || "Image Chat";
                }
                storageService.saveSession(s);
                renderSidebar();
            }
        }

        function updateInputState() {
            if(!els.sendBtn) return;
            els.sendBtn.disabled = state.isLoading;
            els.sendBtn.innerHTML = state.isLoading ? '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>' : '<i data-lucide="send" class="w-4 h-4"></i>';
            if (typeof lucide !== 'undefined') lucide.createIcons();
            if(els.input) els.input.disabled = state.isLoading;
        }

        function renderAttachments() {
            if(state.attachments.length && els.preview) {
                els.preview.classList.remove('hidden');
                els.preview.innerHTML = state.attachments.map((a, i) => `
                    <div class="relative w-16 h-16 flex-shrink-0">
                        <img src="data:${a.mimeType};base64,${a.data}" class="w-full h-full object-cover rounded-lg border border-gray-700">
                        <button onclick="window.removeAttachment(${i})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                `).join('');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } else if (els.preview) {
                els.preview.classList.add('hidden');
            }
        }

        window.removeAttachment = (idx) => {
            state.attachments.splice(idx, 1);
            renderAttachments();
        }

        // Sidebar Toggle
        function toggleSidebar(force) {
            state.isSidebarOpen = force !== undefined ? force : !state.isSidebarOpen;
            const sidebar = document.getElementById('sidebar');
            if(!sidebar) return;
            if(state.isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full', 'hidden');
                sidebar.classList.add('absolute', 'z-50', 'h-full'); 
            } else {
                sidebar.classList.add('-translate-x-full');
                // Only hide on mobile after transition
                if(window.innerWidth < 1024) setTimeout(() => sidebar.classList.add('hidden'), 300);
            }
        }

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>